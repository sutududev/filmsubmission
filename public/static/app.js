async function api(path, opts={}){ const r=await fetch(path, opts); if(!r.ok){ const t=await r.text(); throw new Error(t||('HTTP '+r.status)) } return r.json() }
function h(el, attrs={}, ...children){ const e=document.createElement(el); for(const [k,v] of Object.entries(attrs||{})){ if(k==='class') e.className=v; else if(k.startsWith('on')) e.addEventListener(k.slice(2).toLowerCase(), v); else e.setAttribute(k,v) } for(const c of children.flat()){ if(c==null) continue; if(typeof c==='string') e.appendChild(document.createTextNode(c)); else e.appendChild(c) } return e }

async function loadTitles(){ return loadTitlesFiltered() }
async function loadTitlesFiltered(){ const q=document.getElementById('q')?.value||''; const s=document.getElementById('status')?.value||''; const list=await api(`/api/titles?q=${encodeURIComponent(q)}&status=${encodeURIComponent(s)}`); const wrap=document.getElementById('titles'); wrap.innerHTML=''; const ul=h('ul',{class:'divide-y border rounded bg-white'}); list.forEach(t=>{ const left=h('div',{class:'flex items-center gap-3'}, t.poster_key? h('img',{src:`/api/file/${t.poster_key}`, class:'w-12 h-12 object-cover bg-gray-100 rounded'}): h('div',{class:'w-12 h-12 bg-gray-100 rounded flex items-center justify-center text-gray-400'}, ''), h('div',{}, h('div',{class:'font-semibold'}, t.name), h('div',{class:'text-xs text-gray-500'}, `#${t.id} 路 ${t.status}`))); const li=h('li',{class:'p-3 flex items-center justify-between'}, left, h('a',{href:`/title/${t.id}`, class:'text-blue-600 hover:underline'}, 'Open')); ul.appendChild(li) }); wrap.appendChild(ul); loadUpdates(); }
async function loadUpdates(){ const list=await api('/api/updates?per_page=5'); const box=document.getElementById('updates'); if(!list.length){ box.textContent='No results.'; return } box.innerHTML=''; list.forEach(u=>{ const li=h('div',{class:'border-b py-2 text-sm'}, `${new Date(u.created_at).toLocaleString()} 路 ${u.event_type}`); box.appendChild(li) }) }

async function createTitle(){ const name=prompt('Title name?','New Title'); if(!name) return; await api('/api/titles',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name}) }); await loadTitles() }

async function loadUsage(id){ const u=await api(`/api/titles/${id}/usage`); const bar=document.getElementById('usageBar'); const pct=Math.min(100, Math.round(u.used_bytes*100/u.quota_bytes)); bar.style.width=pct+'%'; bar.textContent=`${(u.used_bytes/1024/1024).toFixed(1)}MB / ${(u.quota_bytes/1024/1024).toFixed(0)}MB`; }

async function loadArtworks(id){ const rows=await api(`/api/titles/${id}/artworks`); const wrap=document.getElementById('artworks'); wrap.innerHTML=''; const grid=h('div',{class:'grid grid-cols-2 md:grid-cols-4 gap-4 p-3'}); rows.forEach(r=>{ const statusChip=h('span',{class:`inline-block px-2 py-0.5 rounded text-xs ${r.status==='approved'?'bg-green-100 text-green-700':r.status==='rejected'?'bg-red-100 text-red-700':'bg-gray-100 text-gray-700'}`}, r.status||'uploaded'); const actions=h('div',{}, h('a',{href:`/api/file/${r.r2_key}`, class:'text-blue-600 mr-3'},'view'), h('button',{class:'text-green-700 mr-2', onclick: async ()=>{ await api(`/api/artworks/${r.id}/status`,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({status:'approved'}) }); loadArtworks(id)}},'approve'), h('button',{class:'text-amber-700 mr-3', onclick: async ()=>{ await api(`/api/artworks/${r.id}/status`,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({status:'rejected'}) }); loadArtworks(id)}},'reject'), h('button',{class:'text-red-600', onclick: async ()=>{ await api(`/api/artworks/${r.id}`,{method:'DELETE'}); loadArtworks(id); loadUsage(id) }},'delete')); const card=h('div',{class:'border rounded bg-white p-2 flex flex-col items-center'}, h('div',{class:'text-xs text-gray-600 self-start mb-1 flex items-center gap-2'}, r.kind, statusChip), h('img',{src:`/api/file/${r.r2_key}`, class:'w-40 h-60 object-cover bg-gray-100 border rounded', alt:r.kind}), h('div',{class:'mt-2 text-xs text-gray-500'}, `${(r.size_bytes||0)/1024|0} KB`), h('div',{class:'mt-2'}, actions)); grid.appendChild(card) }); wrap.appendChild(grid) }

async function loadCaptions(id){ const rows=await api(`/api/titles/${id}/captions`); const wrap=document.getElementById('captions'); wrap.innerHTML=''; rows.forEach(r=>{ const row=h('div',{class:'flex items-center justify-between p-2 border-b'}, h('div',{}, `${r.language}/${r.kind} 路 ${(r.size_bytes||0)/1024|0} KB`), h('div',{}, h('a',{href:`/api/file/${r.r2_key}`, class:'text-blue-600 mr-3'},'view'), h('button',{class:'text-red-600', onclick: async ()=>{ await api(`/api/captions/${r.id}`,{method:'DELETE'}); loadCaptions(id); loadUsage(id) }},'delete'))); wrap.appendChild(row) }) }

const DOC_TYPES=["chain_of_title","copyright_reg","eo_insurance","music_cue_sheet","composer_agreement","talent_release","location_release","underlying_rights","w9_w8","trailer_prores","screener","qc_report","metadata_sheet","poster_psd","key_art_psd","delivery_schedule","other"];
async function loadDocuments(id){ const rows=await api(`/api/titles/${id}/documents`); const wrap=document.getElementById('documents'); wrap.innerHTML=''; // Uploaded list
rows.forEach(r=>{ const statusChip=h('span',{class:`inline-block px-2 py-0.5 rounded text-xs ${r.status==='approved'?'bg-green-100 text-green-700':r.status==='rejected'?'bg-red-100 text-red-700':'bg-gray-100 text-gray-700'}`}, r.status||'uploaded'); const actions=h('div',{}, h('a',{href:`/api/file/${r.r2_key}`, class:'text-blue-600 mr-3'},'view'), h('button',{class:'text-green-700 mr-2', onclick: async ()=>{ await api(`/api/documents/${r.id}/status`,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({status:'approved'}) }); loadDocuments(id)}},'approve'), h('button',{class:'text-amber-700 mr-3', onclick: async ()=>{ await api(`/api/documents/${r.id}/status`,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({status:'rejected'}) }); loadDocuments(id)}},'reject'), h('button',{class:'text-red-600', onclick: async ()=>{ await api(`/api/documents/${r.id}`,{method:'DELETE'}); loadDocuments(id); loadUsage(id) }},'delete'));
  const row=h('div',{class:'flex items-center justify-between p-2 border-b'}, h('div',{}, `${r.doc_type} 路 ${(r.size_bytes||0)/1024|0} KB `, statusChip), actions); wrap.appendChild(row) })
// Checklist
const have=new Set(rows.map(r=>r.doc_type)); const checklist=h('div',{class:'mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2'}); DOC_TYPES.forEach(t=>{ const ok=have.has(t); const chip=h('span',{class:`inline-block px-2 py-0.5 rounded text-xs ${ok?'bg-green-100 text-green-700':'bg-gray-100 text-gray-700'}`}, ok?'present':'missing'); const item=h('div',{class:'p-2 border rounded bg-white flex items-center justify-between'}, h('span',{}, t), chip); checklist.appendChild(item) }); wrap.appendChild(h('div',{class:'mt-2 text-sm text-gray-600'}, 'Checklist (optional):')); wrap.appendChild(checklist) }

async function uploadMultipart(url, fields, fileInput){ const fd=new FormData(); for(const [k,v] of Object.entries(fields)) fd.append(k,v); const f=fileInput.files[0]; if(!f) return alert('Select a file'); fd.append('file', f, f.name); await api(url,{ method:'POST', body:fd }); fileInput.value=''; }

async function saveProfile(id){ const body={}; ['sales_title','synopsis','genres','keywords','format','spoken_language','dubbed_languages','caption_languages','origin_country','runtime_minutes','release_date','rating_system','rating','production_company','website'].forEach(k=>{ const el=document.getElementById('pf_'+k); if(el) body[k]=el.value||null }); await api(`/api/titles/${id}/profile`,{ method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) }); alert('Saved'); }
async function loadProfile(id){ const p=await api(`/api/titles/${id}/profile`); const set=(k,v='')=>{ const el=document.getElementById('pf_'+k); if(el) el.value=v||'' }; if(p){ Object.entries(p).forEach(([k,v])=>{ if(k!=='title_id') set(k, v) }) }
 }
async function loadAvails(id){ const rows=await api(`/api/titles/${id}/avails`); const wrap=document.getElementById('avails'); wrap.innerHTML=''; rows.forEach(r=>{ const row=h('div',{class:'flex items-center justify-between p-2 border-b'}, `${r.license_type} 路 ${r.territories} 路 ${r.start_date} - ${r.end_date||''} ${r.exclusive?'(exclusive)':''}`, h('div',{}, h('button',{class:'text-red-600', onclick: async ()=>{ await api(`/api/avails/${r.id}`,{method:'DELETE'}); loadAvails(id)}},'delete'))); wrap.appendChild(row) }) }
async function createAvail(id){ const license_type=document.getElementById('av_type').value; const territories=document.getElementById('av_terr').value; const start_date=document.getElementById('av_start').value; const end_date=document.getElementById('av_end').value||null; const exclusive=document.getElementById('av_excl').checked; await api(`/api/titles/${id}/avails`,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ license_type, territories, start_date, end_date, exclusive }) }); document.getElementById('av_terr').value=''; loadAvails(id)}

window.APP={ loadTitles, loadTitlesFiltered, createTitle, loadUsage, loadArtworks, loadCaptions, loadDocuments, uploadMultipart, loadProfile, saveProfile, loadAvails, createAvail }